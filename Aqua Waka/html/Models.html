<!DOCTYPE html>
<html>
<head>
	<title>Modelos</title>
	<script type="text/javascript" src="js/libs/jquery/jquery-2.1.4.min.js"></script>

	<script type="text/javascript" src="js/libs/three/three2.js"></script>
	<!-- <script type="text/javascript" src="js/libs/three/three.js"></script> -->
	<script type="text/javascript" src="js/libs/three/MTLLoader.js"></script>
	<script type="text/javascript" src="js/libs/three/OBJLoader.js"></script>
	<script type="text/javascript" src="js/libs/three/FBXLoader.js"></script>
	<script type="text/javascript" src="js/libs/three/inflate.min.js"></script>
	<script type="module" src="js/libs/three/Math/Box3.js"></script>
	
	

	<script type="text/javascript">
		
		var scene, camera, renderer; 
		var controls, clock, deltaTime;
		var objects = [];
		var keys = {};
		var cube, cube2, cubeSmash;
		var isWorldReady = [false, false];
		var texturewater;
		var objs = [];
		var cubesCol = [];
		
		//Colisiones var
		var collidableMeshList = [];

		$(document).ready(function(){
			
			setupScene();

			//Back Island
			loadOBJWithMTL("assets/Island/", "Island.obj", "Island.mtl", (object) => {

				object.position.z = -40;

				object.position.y = -1;

				// object.rotation.y = THREE.Math.degToRad(-90);
				object.scale.x = 4.0;
				object.scale.y = 3.5;
				object.scale.z = 4.0;

				object.rotation.y = THREE.Math.degToRad(90);

				//var isla3 = object.clone();
				scene.add(object);

				isWorldReady[0] = true;
			});

			//New Isla Left
			loadOBJWithMTL("assets/Island/", "newisland.obj", "newisland.mtl", (object) => {

				object.position.x = -60; 
				object.position.y = -0.5;
				object.position.z = -2; //delante(+) y atras(-)
				
				object.scale.x = 3.0;
				object.scale.y = 2.5;
				object.scale.z = 3.0;

				object.rotation.y = THREE.Math.degToRad(112);

				scene.add(object);
			});

			loadOBJWithMTL("assets/pokeisla/", "KittyIsland.obj", "KittyIsland.mtl", (object) => {

				object.position.x = -70; 
				object.position.y = -12;
				object.position.z = -60; //delante(+) y atras(-)
				
				object.scale.x = 3.0;
				object.scale.y = 3.0;
				object.scale.z = 3.0;

				var isla2 = object.clone();
				isla2.position.x = 80;
				object.rotation.y = THREE.Math.degToRad(-50);

				object.rotation.y = THREE.Math.degToRad(50);
				scene.add(object);
				scene.add(isla2);
			});

			loadOBJWithMTL("assets/barcopirata/", "PirateShip.obj", "PirateShip.mtl", (object) => {

				object.position.x = 52;
				object.position.y = -6; 
				object.position.z = 7; //delante(+) y atras(-)
				
				object.scale.x = 2.0;
				object.scale.y = 2.0;
				object.scale.z = 2.0;

				object.rotation.y = THREE.Math.degToRad(180);
				object.rotation.x = THREE.Math.degToRad(-4);
				scene.add(object);
			});

			loadOBJWithMTL("assets/roca/", "roca.obj", "roca.mtl", (object) => {

				object.position.x = -50;
				object.position.y = -5; 
				object.position.z = 38; //delante(+) y atras(-)
				
				object.scale.x = 2.5;
				object.scale.y = 2.5;
				object.scale.z = 2.5;

				var roca2 = object.clone();
				object.position.x = 50;
				object.position.y = -5; 
				object.position.z = 35;

				object.rotation.y = THREE.Math.degToRad(180);

				scene.add(object);
				scene.add(roca2);
			});

			loadOBJWithMTL("assets/salvavidas/", "salva.obj", "salva.mtl", (object) => {

				object.position.x = 30;
				object.position.y = 2; 
				object.position.z = 45; //delante(+) y atras(-)
				
				object.scale.x = 1.2;
				object.scale.y = 1.2;
				object.scale.z = 1.2;
				scene.add(object);
				
			});

			loadOBJWithMTL("assets/", "KO_Hammer_Brawl.obj", "KO_Hammer_Brawl.mtl", (object) => {

				object.scale.x = 0.4;
				object.scale.y = 0.4;
				object.scale.z = 0.4;

				cube.add(object);

				
			});

			//Water
			texturewater = new THREE.TextureLoader().load("../sources/water.png");
			texturewater.wrapS = texturewater.wrapT = THREE.RepeatWrapping;
			texturewater.repeat.set(0.6,0.6);

			var floorMaterial = new THREE.MeshBasicMaterial({map: texturewater, side: THREE.DoubleSide});
			var floorGeometry = new THREE.PlaneGeometry(300, 200, 10, 10);
			var floor = new THREE.Mesh(floorGeometry, floorMaterial);
			floor.position.y = -0.12;
			floor.rotation.x = Math.PI /2;
			scene.add(floor);

			
			render();
			document.addEventListener('keydown', onKeyDown);
			document.addEventListener('keyup', onKeyUp);	

			//------------Skydome--------------		
			createSkydome();

			//========================CARGA DE FBX

			//Piranha
			var loader = new THREE.FBXLoader();
			loader.load('assets/FBX/Pira.fbx', model => {
				var mixer = new THREE.AnimationMixer(model);

				//Scale
				model.scale.x = 1.20;
				model.scale.y = 1.20;
				model.scale.z = 1.20;

				//Position
				model.position.z = 28; //frente(+) + atras(-)
				model.position.x = 25; //izq(-) + der(+)
				model.position.y = -1;

				//Rotation
				model.rotation.x = THREE.Math.degToRad(-25);

				var action = mixer.clipAction(model.animations[0]);
				
				scene.add(model);
				// Colision
				//sObj = new THREE.Box3().setFromObject(model);

				action.play();
				action.setLoop(THREE.Loop);
				action.timeScale = 500;
				objs.push({model, mixer});
				model.name = "Pirana";
			});

			//Pez Globo
			loader.load('assets/FBX/AnimacionesGlobo.fbx', model => {
				var mixer = new THREE.AnimationMixer(model);

				//Scale
				model.scale.x = 1.10;
				model.scale.y = 1.10;
				model.scale.z = 1.10;

				//Position
				model.position.z = 15; //frente(+) + atras(-)
				model.position.x = 12; //izq(-) + der(+)
				model.position.y = 0.5;

				//Rotation
				model.rotation.y = THREE.Math.degToRad(-90);
				model.rotation.x = THREE.Math.degToRad(-25);

				var action = mixer.clipAction(model.animations[0]);

				scene.add(model);
				action.play();
				action.setLoop(THREE.Loop);
				action.timeScale = 500;
				objs.push({model, mixer});
				model.name = "Globo";
			});

			//Pulpo
			loader.load('assets/FBX/AnimacionesPulpoHelp.fbx', model => {
				var mixer = new THREE.AnimationMixer(model);

				//Scale
				model.scale.x = 4.20;
				model.scale.y = 4.20;
				model.scale.z = 4.20;

				//Position
				model.position.z = 15; //frente(+) + atras(-)
				model.position.x = -10;//izq(-) + der(+)
				model.position.y = 2;

				//Rotation
				model.rotation.x = THREE.Math.degToRad(-25);

				var action = mixer.clipAction(model.animations[0]);

				scene.add(model);
				action.play();
				action.setLoop(THREE.Loop);
				action.timeScale = 500;
				objs.push({model, mixer});
				model.name = "Pulpo";
			});

			//Tiburon
			loader.load('assets/FBX/AnimacionesTiburon.fbx', model => {
				var mixer = new THREE.AnimationMixer(model);

				//Scale
				model.scale.x = 0.25;
				model.scale.y = 0.25;
				model.scale.z = 0.25;

				//Position
				model.position.z = 25; //frente(+) + atras(-)
				model.position.x = -30; //izq(-) + der(+)
				model.position.y = -1.50;

				//Rotation
				model.rotation.y = THREE.Math.degToRad(-45);
				model.rotation.x = THREE.Math.degToRad(-55);

				var action = mixer.clipAction(model.animations[0]);

				scene.add(model);
				action.play();
				action.setLoop(THREE.Loop);
				action.timeScale = 500;
				objs.push({model, mixer});
				model.name = "Tiburon";
			});

			//LightFish
			loader.load('assets/FBX/LightFish.fbx', model => {
				var mixer = new THREE.AnimationMixer(model);

				//Scale
				model.scale.x = 1.20;
				model.scale.y = 1.20;
				model.scale.z = 1.20;

				//Position
				model.position.z = 25; //frente(+) + atras(-)
				model.position.x = 0; //izq(-) + der(+)
				model.position.y = 2.5;

				//Rotation
				model.rotation.x = THREE.Math.degToRad(-5);

				var action = mixer.clipAction(model.animations[0]);

				scene.add(model);
				action.play();
				action.setLoop(THREE.Loop);
				action.timeScale = 500;
				objs.push({model, mixer});
				model.name = "Lightfish";
			});

		});


		function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
			var mtlLoader = new THREE.MTLLoader();
			mtlLoader.setPath(path);
			mtlLoader.load(mtlFile, (materials) => {
				
				var objLoader = new THREE.OBJLoader();
				objLoader.setMaterials(materials);
				objLoader.setPath(path);
				objLoader.load(objFile, (object) => {
					onLoadCallback(object);
				});

			});
		}	

		function onKeyDown(event) {
			keys[String.fromCharCode(event.keyCode)] = true;
		}
		function onKeyUp(event) {
			keys[String.fromCharCode(event.keyCode)] = false;
		}

		function render(){

			requestAnimationFrame(render);
			deltaTime = clock.getDelta();	

			yaw = 0;
			forward = 0;
			if (keys["A"]) {
				yaw = -20;
			} else if (keys["D"]) {
				yaw = 20;
			}
			if (keys["W"]) {
				forward = -20;
			} else if (keys["S"]) {
				forward = 20;
			}

			if(keys["X"]){
				cube.rotation.x = THREE.Math.degToRad(-90);
				//Colision
				Colisiona(cubeSmash);
				yaw = 0;
				forward = 0;
				
			}else {
				
				cube.rotation.x = THREE.Math.degToRad(0);
			}
			if (isWorldReady[0]) {
				
				// camera.rotation.y += yaw * deltaTime;
				// camera.translateZ(forward * deltaTime);
				cube.translateZ( forward * deltaTime);
				cube.translateX(yaw * deltaTime);
				cubeSmash.translateZ( forward * deltaTime);
				cubeSmash.translateX(yaw * deltaTime);
				objs.forEach(({mixer})=> {mixer.update(clock.getDelta());});

			}
			

			texturewater.offset.x +=.0003;
			// cube.rotation.y += yaw * deltaTime; 
			renderer.render(scene, camera);
			// camera.lookAt(objectMov.position);

		}

		function setupScene() {		
			var visibleSize = { width: 800, height: 400};
			clock = new THREE.Clock();		
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(75, visibleSize.width / visibleSize.height, 0.1, 200);
			camera.position.z = 0;
			// camera.position.y = 5;

			renderer = new THREE.WebGLRenderer( {precision: "mediump" } );
			renderer.setClearColor(new THREE.Color(0, 1, .9));
			renderer.setPixelRatio(visibleSize.width / visibleSize.height);
			renderer.setSize(visibleSize.width, visibleSize.height);

			var ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
			scene.add(ambientLight);

			var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 0), 0.4);
			directionalLight.position.set(0, 0, 1);
			scene.add(directionalLight);

			var grid = new THREE.GridHelper(50, 10, 0xffffff, 0xffffff);
			grid.position.y = -1;
			//scene.add(grid);


			//-------CUBOS---------------
			var material = new THREE.MeshPhongMaterial({
				color: new THREE.Color(0.1, 1.0, 0.0),
				opacity: .0,
				transparent: true,
			});

			var material2 = new THREE.MeshPhongMaterial({
				color: new THREE.Color(0.1, 1.0, 0.0),
				opacity: .7,
				transparent: true,
			});


			//-----CUBO MAZO------------
			var geometry = new THREE.BoxGeometry(1, 1, 1);
			cube = new THREE.Mesh(geometry, material);
			cube.position.y = 2;
			cube.position.x = 0;
			cube.position.z = 20;
			scene.add(cube);
			
			//----Cubo golpe---------
			cubeSmash = new THREE.Mesh(geometry, material);
			cubeSmash.scale.x = 5;
			cubeSmash.scale.y = 5;
			cubeSmash.scale.z = 5;

			cubeSmash.position.y = 8.90;
			cubeSmash.position.z = 10;
			scene.add(cubeSmash);

			//---CUBOS COLISION-----------

			camera.position.y = 30;
			camera.position.z = 60;

			createCubes(geometry, material2, cubesCol[1], 25,3,28, 7, 7,7);
			createCubes(geometry, material2, cubesCol[2], 12,3,15, 7, 7,7);
			createCubes(geometry, material2, cubesCol[3], -10,3,15, 7, 7,7);
			createCubes(geometry, material2, cubesCol[4], -30,3,25,10, 10,10);
			createCubes(geometry, material2, cubesCol[5], 0,3,25,7, 7,7);

			// camera.rotation.y = THREE.Math.degToRad(-45);
			
			camera.rotation.x = THREE.Math.degToRad(-38);  //cambio a 38
			$("#scene-section").append(renderer.domElement);
			
		}

		function createSkydome(){
			var skyDom = new THREE.SphereGeometry(166, 25 ,25);
			var loader = new THREE.TextureLoader(),
			texture = loader.load("../sources/Sky.png");
			var material = new THREE.MeshPhongMaterial({ 
        	map: texture,
			});
			var sky = new THREE.Mesh(skyDom, material);
    		sky.material.side = THREE.BackSide;
			sky.position.z = 40;
			sky.position.y = 4;
    		scene.add(sky);
		}

		function createCubes(Pgeometry, Pmaterial, Pname, Px, Py,Pz, P_sx, P_sy, P_sz){
			Pname = new THREE.Mesh(Pgeometry, Pmaterial);
			Pname.position.x = Px;
			Pname.position.y = Py;
			Pname.position.z = Pz;
			

			Pname.scale.x = P_sx;
			Pname.scale.z = P_sy;
			Pname.scale.y = P_sz;

			scene.add(Pname);
			collidableMeshList.push(Pname);
		}

		function Colisiona(CuboMazo){
				var originPoint = CuboMazo.position.clone();
				for(var vertexIndex = 0; vertexIndex < CuboMazo.geometry.vertices.length; vertexIndex++){
					var localVextex = CuboMazo.geometry.vertices[vertexIndex].clone();
					var globalVertex = localVextex.applyMatrix4(CuboMazo.matrix);
					var directionVector = globalVertex.sub(CuboMazo.position);

					var ray = new THREE.Raycaster(originPoint, directionVector.clone().normalize());
					var collisionResults = ray.intersectObjects(collidableMeshList);

					if(collisionResults.length > 0 && collisionResults[0].distance < directionVector.length()){
					$("#Colision").append("<p>Hola hay colision</p>")
					}else $("#Colision").append("<p></p>")

				}
		}

	</script>

</head>



<body>

	<div id="scene-section"></div>

	<div id="Colision"></div>

</body>
</html>